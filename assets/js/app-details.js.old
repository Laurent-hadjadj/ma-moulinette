/*
 *  Copyright (c) 2021-2022.
 *  Laurent HADJADJ <laurent_h@me.com>.
 *  Licensed Creative Common  CC-BY-NC-SA 4.0.
 *  Vous pouvez obtenir une copie de la licence à l'adresse suivante :
 *  http://creativecommons.org/licenses/by-nc-sa/4.0/
 *
 */
/* eslint-disable jquery/no-ready */
/* eslint-disable jquery/no-class */
/* eslint-disable jquery/no-show */
/* eslint-disable jquery/no-hide */

import '../css/details.css';

// Intégration de jquery
import $ from 'jquery';

import 'what-input';
import 'foundation-sites';
import 'motion-ui';

import './foundation.js';

console.log('Details : Chargement de webpack !');

const date_options = {
  year: "numeric", month: "numeric", day: "numeric",
  hour: "numeric", minute: "numeric", second: "numeric",
  hour12: false
};

const contentType='application/json; charset=utf-8';

/**
 * description
 * Affiche la log.
 */
function log(txt) {
  let textarea = document.getElementById('log');
  textarea.scrollTop = textarea.scrollHeight;
  textarea.value += new Intl.DateTimeFormat('default', date_options).format(new Date()) + txt + '\n';
}

/**
 * description
 * Initialisation de la log.
 */
function dit_bonjour() { log(' - Initialisation de la log...'); }

/**
 * description
 * Active la gomme pour nettoyer la log.
 */
$('.gomme-svg').on('click', function (e) {
  $('.log').val('');
});

/**
 * description
 * Active le spinner.
 */
function start_spinner() {
  if ($('#loader').hasClass('loader-disabled')) {
    $('#loader').removeClass('loader-disabled');
    $('#loader').addClass('loader-enabled');
  }
}

/**
 * description
 * Désactive le spinner.
 */
function stop_spinner() {
  if ($('#loader').hasClass('loader-enabled')) {
    $('#loader').removeClass('loader-enabled');
    $('#loader').addClass('loader-disabled');
  }
}

/**
 * description
 * Active la gomme pour nettoyer la log.
 */
$('.gomme-svg').on('click', function (e) { $('.log').val(''); });

/**
 * description
 * Récupère les indicateurs et leur niveau de sévérité.
 */
function projet_anomalie_setup() {
  const options = {
    url: 'http://localhost:8000/api/projet/anomalies/setup', type: 'GET', dataType: 'json', contentType: contentType }

  return $.ajax(options).then(
    (t) => {
      log(' - INFO : Dernier setup : ' + t.setup);
      localStorage.setItem('setup', t.setup)
      log(' - WARM : Attention l\'analyse des données peut durer plusieurs minutes. 6 minutes pour 10 000 défauts.');
    });
}

/*
 * description
* Fonction à deux balles pour ajouter une tempotisation entre les appels
* de traitement des anomalies quand le nombre atteint 10000 !!!
*/
function notifyUser(type, nombre, info) {
  log(' - INFO : Analyse des ' + type + ' : ' + nombre);
  log('            : ' + info);
}

/**
 * description
 * Récupère les défauts, la dette technique et le niveau de sévérité.
 * Arguements :
 *  maven_key = clé du projet, type = BUG, VULNERABILITY, CODE_SMELL, setup = version de l'analyse.
 *
 */
function projet_anomalie(maven_key, type, setup) {
  const data = { maven_key: maven_key, type: type, setup: setup };
  const options = {
    url: 'http://localhost:8000/api/projet/anomalies/ajout', type: 'GET', dataType: 'json', data: data, contentType: contentType }

  return $.ajax(options).then(
    (t) => {
      /* On temporise pour éviter que les appels asynchronnes se lance tous en même temps.
       * Temporisation : 8 secondes.
      */
      setTimeout(() => { notifyUser(type, t.nombre, t.info); }, 8000);
    });
}

/**
 * description
 * On calcule les stastiques consolidées sur les anomalies
 */
function projet_anomalie_consolidation(maven_key, setup){
  const data = { maven_key: maven_key, setup: setup };
  const options = {
    url: 'http://localhost:8000/api/projet/anomalies/consolidation', type: 'GET', dataType: 'json', data: data, contentType: contentType }

  return $.ajax(options).then(
    (t) => {
      log(' - INFO : ' + t.info);
    });
}


/*************** Main du programme **************/
// On dit bonjour
dit_bonjour();

/**
 * description
 * Lance la collecte des données du projet sélectionné.
 */
$('.js-analyse').on('click', function () {
  setTimeout(function () { start_spinner(); }, 2000);
  log(' - INFO : On lance la collecte...');
  // on bloque le bouton afficher les resultats
  if (id_project == 'N.C') { log(' - ERROR : Vous devez chisir un projet !!!'); return }

  projet_anomalie_setup();
  const setup = localStorage.getItem('setup');

  projet_anomalie(id_project, 'BUG', setup);
  projet_anomalie(id_project, 'VULNERABILITY', setup);
  projet_anomalie(id_project, 'CODE_SMELL', setup);
  projet_anomalie_consolidation(id_project, setup);

  setTimeout(function () { stop_spinner(); }, 5000);
})

/************* Events ***************************/
/**
 * description
 * On passe à la peinture
 */
$('.js-affiche-resultat').on('click', function () {
  // On récupère la clé du projet
  let api_maven = $('#select-result').text().trim();
  // On appel une fonction externe
  if ( $('.js-affiche-resultat').hasClass('affiche-resultat-enabled'))
    { remplissage(api_maven);
      if ($('#enregistrement').hasClass('enregistrement-disabled'))
        {
          $('#enregistrement').addClass('enregistrement');
          $('#enregistrement').removeClass('enregistrement-disabled');
        }
    }
})

/**
 * description
 * On lance l'enregistrement des données
 */
 $('.js-enregistrement').on('click', function () {
  // On récupère la clé du projet
  let api_maven = $('#select-result').text().trim();
  enregistrement(api_maven);
 })
